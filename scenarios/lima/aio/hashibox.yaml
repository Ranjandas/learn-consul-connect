images:
  # Try to use a local image first.
  - location: ~/artifacts/qemu/c-1.18-n-1.7.7/c-1.18-n-1.7.7.qcow2


mounts: []
containerd:
  system: false
  user: false
provision:
  - mode: system # configure Consul
    script: |
      #!/bin/sh
      cat <<-EOF | tee /etc/consul.d/consul.hcl
      data_dir  = "/opt/consul/data"
      log_level  = "INFO"
      bind_addr = {{ "\"{{ GetInterfaceIP \\\"eth0\\\"}}\"" }}
      client_addr = "0.0.0.0"
      retry_join = ["localhost"]
      

      ui_config {
        enabled = true
      }

      connect {
        enabled = true
      }

      server = true
      bootstrap_expect = 1

      EOF

  - mode: system # configure Nomad
    script: |
      cat <<-EOF | tee /etc/nomad.d/nomad.hcl
      data_dir  = "/opt/nomad/data"
      log_level  = "INFO"
      bind_addr = "0.0.0.0"

      server {
        # license_path is required for Nomad Enterprise as of Nomad v1.1.1+
        #license_path = "/etc/nomad.d/license.hclic"
        enabled          = true
        bootstrap_expect = 1

        server_join {
          retry_join = ["localhost"]
        }
      }

      client {
        enabled = true
        servers = ["localhost"]
      }
      
      plugin "raw_exec" {
        config {
        enabled = true
        }
      }

      EOF

      cat <<-EOF | tee /etc/sysctl.d/bridge.conf
      net.bridge.bridge-nf-call-arptables = 1
      net.bridge.bridge-nf-call-ip6tables = 1
      net.bridge.bridge-nf-call-iptables = 1
      EOF

      # link the CNI directory
      mkdir /opt/cni
      ln -s /usr/libexec/cni/ /opt/cni/bin
  - mode:
    script: |
      systemctl enable --now docker
      systemctl enable --now nomad consul
  - mode: user
    script: |
      #!/bin/sh
      nomad -autocomplete-install
      consul -autocomplete-install
networks:
  - lima: user-v2
vmType: qemu
